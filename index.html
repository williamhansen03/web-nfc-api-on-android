<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#062f55">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="pragma" content="no-cache">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="image/icon72x72.png">
    <link rel="apple-touch-icon" href="image/icon192x192.png">
    <title>Web NFC API on android</title>

    <style>
        #scanButton{
            display: none;
            width: 4rem;
            height: 2rem;
        }
    </style>
</head>
<body>
    <h1>
        Testar hur NFC API till android fungerar.
    </h1>

    <button id = "scanButton">Scan</button>

    <p>
        NFC enabled?
    </p>

    <h2></h2>

    <script>
    
    const color = document.body;
color.style.backgroundColor = "#000000";

const text = document.querySelector("h1");
const nfcText = document.querySelector("p");

const nfcPermissionStatus = navigator.permissions.query({ name: "nfc" });

nfcText.innerHTML = nfcPermissionStatus.state;


//Look if the device have NFC
function startScanning(){
    const ndef = new NDEFReader();

    while(true){

        ndef.scan().then(() => {
            text.innerHTML = "Scan started successfully.";
            console.log("Scan started successfully.");
            color.style.backgroundColor = "#A020F0";
        
            ndef.addEventListener("readingerror", () => {
                text.innerHTML = "Error! Cannot read data from the NFC tag. Try a different one?";
                console.log("Error! Cannot read data from the NFC tag. Try a different one?");
                color.style.backgroundColor = "#ff0000";
            });

            ndef.addEventListener("reading", ({ message, serialNumber }) => {
                const info = document.querySelector("h2");
                info.innerHTML = message + ", " + serialNumber;
                text.innerHTML = "NDEF message read.";
                console.log("NDEF message read.");
                delay(400).then(() => color.style.backgroundColor = "#00ff00");
            });

            }).catch((error) => {
            text.innerHTML = `Error! Scan failed to start: ${error}.`;
            console.log(`Error! Scan failed to start: ${error}.`);
            color.style.backgroundColor = "#ff0000";
        });
    }
}


if ('NDEFReader' in window) {
    text.innerHTML = "Look if the device have NFC";
    

    

    color.style.backgroundColor = "#ffff00";
    
    if (nfcPermissionStatus.state === "granted") {
        // NFC access was previously granted, so we can start NFC scanning now.
        startScanning();

      } else {
        // Show a "scan" button.
        //document.querySelector("#scanButton").style.display = "block";
        //document.querySelector("#scanButton").onclick = event => {
          // Prompt user to allow UA to send and receive info when they tap NFC devices.
          startScanning();
        //};
      }
        //Start scaning for NFC tags

        
}
else{
    text.innerHTML = "No nfc reader or browser does not support NDEFReader";
    color.style.backgroundColor = "#0000ff";
}

function delay(time) {
    return new Promise(resolve => setTimeout(resolve, time));
}



    /*if("serviceWorker" in navigator){
        document.body.style.backgroundColor = "#555555";
        navigator.serviceWorker.register("sw.js").then(registration => {            
            console.log("SW Registered");
            console.log(registration);
        }).catch(error => {
            
            console.log("SW Registration Failed!");
            console.log(error);
        });
    }*/

    </script>
    <script src="js/scripts.js"></script>
</body>
</html>